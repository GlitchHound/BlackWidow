/*************************************

    BlackWidow is a command-based interface for a social network.
    Copyright Â© 2012 Bilawal Hameed, Alejandro Sauze Saucedo, Charlie Brensinger, Anton Smyrnov, Sari Ghamloush

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.

*************************************/

var BW={version:"1.0.5",text:{username:"guest: ",no_jquery:"Sorry, Black Widow "+this.version+" requires jQuery to run.",no_base64:"Sorry, Black Widow "+this.version+" requires jQuery.Base64.js to run.",no_browser:"Sorry, Black Widow "+this.version+" requires jQuery.browser.js to run.",no_konami:"Sorry, Black Widow "+this.version+" requires jQuery.konami.js to run.",xml_invalid:"The XML file for BlackWidow you tried to request is not in a supported format.",xml_newer:"Sorry, your XML configuration is too new for usage in Black Widow "+this.version,xml_outdated:"Sorry, your XML config version is too old on BW version of Black Widow.",no_help:"There is no help available on the command '%'",help_prepend:"HELP: ",console_error_debug:"An internal error occurred: %",console_error:"Sorry, an error occurred while trying to process your command. Try again later."},elements:{sticky:"#%-indicator",console_screen:"#screen",display:"#display",console_entry:"#inputline",console_prompt:"#prompt",console_left_command:"#lcommand",console_right_command:"#rcommand",console_cursor:"#cursor",console_loading:"#spinner",command:".command",bottom_line:"#bottomline"},metadata:{endpoint:"api.php?1.0",xml_file:"xml/configuration.xml",config:{debug:false,UNDEF:"undefined",scrollStep:20,scrollSpeed:100,bg_color:"#000",fg_color:"#FFF",cursor_blink_time:700,cursor_style:"block",spinnerCharacters:["[   ]","[.  ]","[.. ]","[...]"],spinnerSpeed:250,typingSpeed:50,popupTemplate:"<html><body>%content%</body></html>"},aliases:{},pages:{},help:{},lastCommand:"",terminalconfig:{buffer:"",pos:0,history:[],historyPos:0,promptActive:true,cursorBlinkState:true,_cursorBlinkTimeout:null,spinnerIndex:0,_spinnerTimeout:null}},authors:function(){return["Bilawal Hameed","Alejandro Sauze Saucedo","Charlie Brensinger","Anton Smyrnov","Sari Ghamloush"]},functions:{ltrim:function(a){return a.replace(/\s*((\S+\s*)*)/,"$1")||""},format:function(a){return a.replace(/_/g,"_").replace(/ /g,"_").replace(/:/g,"_").replace(/\\/g,"_").replace(/\//g,"_").replace(/[^a-zA-Z0-9\-]+/g,"").replace(/-{2,}/g,"_").toLowerCase()},error:function(a){return $("<p>").addClass("error").text(a)},rtrim:function(a){return a.replace(/((\s*\S+)*)\s*/,"$1")||""},htmlentities:function(a){a=a.replace(/&/g,"&");a=a.replace(/</g,"<");a=a.replace(/>/g,">");a=a.replace(/ /g," ");if(/msie/i.test(navigator.userAgent))a=a.replace("\n"," <br />");else a=a.replace(/\x0D/g," <br />");return a||""},unsetEngine:function(a){BW={};if(a){alert(a)}return false},sticky:{keys:{ctrl:false,alt:false,scroll:false},set:function(a,b){BW.functions.sticky.keys[a]=b;$(BW.elements["sticky"].replace("%",a)).toggle(BW.functions.sticky.keys[a])},toggle:function(a){BW.functions.sticky.set(a,!BW.functions.sticky.keys[a])},reset:function(a){BW.functions.sticky.set(a,false)},resetAll:function(a){$.each(BW.functions.sticky.keys,$.proxy(function(a,b){BW.functions.sticky.reset(a)},BW))}}},init:function(a){if(typeof jQuery==BW.metadata.config.UNDEF){BW.functions.unsetEngine(BW.text["no_jquery"]);return}if(typeof jQuery.base64==BW.metadata.config.UNDEF){BW.functions.unsetEngine(BW.text["no_base64"]);return}if(typeof jQuery.browserTest==BW.metadata.config.UNDEF){BW.functions.unsetEngine(BW.text["no_browser"]);return}if(typeof jQuery.fn.konami==BW.metadata.config.UNDEF){BW.functions.unsetEngine(BW.text["no_konami"]);return}if(typeof a!==BW.metadata.config.UNDEF){if(typeof a.disableHeaderObject=="boolean"&&a.disableHeaderObject==TRUE){window.bw=BW}if(typeof a.url!==BW.metadata.config.UNDEF&&a.url!==""){BW.metadata.endpoint=a.url}if(typeof a.xmlurl!==BW.metadata.config.UNDEF&&a.xmlurl!==""){BW.metadata.xml_file=a.xmlurl}}$.fn.outerHTML=function(){return $("<div>").append(this.eq(0).clone()).html().replace("<html>","").replace("</html>","")};BW.terminal.importData();BW.terminal.run()},terminal:{output:BW,importData:function(){this.data={type:"GET",url:BW.metadata.xml_file,dataType:"xml",success:function(a){$object=$(a).find("blackwidow");if($object.length==0){return BW.functions.unsetEngine(BW.text["xml_invalid"])}if(Math.floor($object.find("version").text())>Math.floor(BW.version)){return BW.functions.unsetEngine(BW.text["xml_newer"])}if(Math.floor($object.find("version").text())<Math.floor(BW.version)){return BW.functions.unsetEngine(BW.text["xml_outdated"])}$object.find("aliases item").each(function(a){var b=$(this).find("name").text();var c=$(this).find("redirect").text();BW.metadata.aliases[b]=c});$object.find("pages item").each(function(a){var b=$(this).find("name").text();BW.metadata.pages[b]={output:$(this).find("html").outerHTML(),title:$(this).find("title").text(),width:$(this).find("width").text()||600,height:$(this).find("height").text()||200,type:$(this).find("type").text()||"internal"}});$object.find("welcome item").each(function(a){if($(this).children().size()>0){$(this).children().each(function(){BW.terminal.runText($(this).text(),$(this).get(0).tagName)})}else{BW.terminal.runCommand($(this).text())}});$object.find("help item").each(function(a){var b=$(this).find("name").text();var c=$(this).find("text").text();BW.metadata.help[b]=c});if($object.find("pages global template").outerHTML().length>0){BW.metadata.config.popupTemplate="<html>"+$object.find("pages global template").outerHTML().replace("<template>","").replace("</template>","")+"</html>"}}};$.ajax(this.data)},process:function(a,b){try{var c=b.split(" ");var d=c.shift();c.unshift(a);if(BW.metadata.aliases.hasOwnProperty(d)){d=BW.metadata.aliases[d]}if(d=="clear"){BW.terminal.clear()}else if(d=="help"&&typeof c[1]!==BW.metadata.config.UNDEF){var e=c[1];if(BW.metadata.help[e]){BW.terminal.print(BW.text["help_prepend"]+BW.metadata.help[e])}else{BW.terminal.print(BW.functions.error(BW.text["no_help"].replace("%",e)))}}else if(BW.metadata.pages.hasOwnProperty(d)){var f=BW.metadata.pages[d]["output"];var g=BW.metadata.pages[d]["type"]||"internal";if(g=="external"||g=="external_popup"){var h=BW.metadata.config.popupTemplate.replace("%title%",BW.metadata.pages[d]["title"]).replace("%content%",f);if(g=="external"){BW.terminal.print($("<iframe></iframe>").attr("width",BW.metadata.pages[d]["width"]).attr("height",BW.metadata.pages[d]["height"]).attr("frameborder",0).attr("src","data:text/html;base64,"+$.base64.encode(h)))}else if(g=="external_popup"){window.open("data:text/html;base64,"+$.base64.encode(h),"blackwidow_"+BW.functions.format(BW.metadata.pages[d]["title"]),"toolbar=0, menubar=0, location=no, scrollbars=1, resizable=1, status=0").resizeTo(BW.metadata.pages[d]["width"],BW.metadata.pages[d]["height"])}}else{$("<div>").html(f).children().each(function(){BW.terminal.print($($(this).outerHTML()))})}}else{var i={url:BW.metadata.endpoint,cache:false,dataType:"html",data:{HTTP_X_BW_COMMAND:b,HTTP_X_BW_TIMESTAMP:Math.round((new Date).getTime()/1e3),HTTP_X_BW_VERSION:BW.version},success:function(a){try{$("<div>").html(f).children().each(function(){BW.terminal.print($($(this).outerHTML()))})}catch(b){BW.terminal.print(a)}},error:function(a){BW.terminal.print(BW.functions.error(BW.text["console_error"]))}};$.ajax(i)}BW.metadata.lastCommand=b}catch(j){var k=BW.metadata.config.debug==true?"console_error_debug":"console_error";BW.terminal.print($("<p>").addClass("error").text(BW.text["console_error_debug"].replace("%",j)));BW.terminal.setWorking(false)}},isActive:function(a){return function(){if(BW.metadata.terminalconfig.promptActive){a.apply(BW,arguments)}}},setCursorState:function(a,b){BW.metadata.terminalconfig.cursorBlinkState=a;if(BW.metadata.config.cursor_style=="block"){if(a){$(BW.elements["console_cursor"]).css({color:BW.metadata.config.bg_color,backgroundColor:BW.metadata.config.fg_color})}else{$(BW.elements["console_cursor"]).css({color:BW.metadata.config.fg_color,background:"none"})}}else{if(a){$(BW.elements["console_cursor"]).css("textDecoration","underline")}else{$(BW.elements["console_cursor"]).css("textDecoration","none")}}if(!b&&BW.metadata.terminalconfig._cursorBlinkTimeout){window.clearTimeout(BW.metadata.terminalconfig._cursorBlinkTimeout);BW.metadata.terminalconfig._cursorBlinkTimeout=null}BW.metadata.terminalconfig._cursorBlinkTimeout=window.setTimeout($.proxy(function(){BW.terminal.setCursorState(!BW.metadata.terminalconfig.cursorBlinkState,true)},BW),BW.metadata.config.cursor_blink_time)},updateInputDisplay:function(){var a="",b=" ",c="";if(BW.pos<0){BW.metadata.terminalconfig.pos=0}if(BW.metadata.terminalconfig.pos>BW.metadata.terminalconfig.buffer.length){BW.metadata.terminalconfig.pos=BW.metadata.terminalconfig.buffer.length}if(BW.metadata.terminalconfig.pos>0){a=BW.metadata.terminalconfig.buffer.substr(0,BW.pos)}if(BW.metadata.terminalconfig.pos<BW.metadata.terminalconfig.buffer.length){b=BW.metadata.terminalconfig.buffer.substr(BW.metadata.terminalconfig.pos,1)}if(BW.metadata.terminalconfig.buffer.length-BW.metadata.terminalconfig.pos>1){c=BW.metadata.terminalconfig.buffer.substr(BW.metadata.terminalconfig.pos+1,BW.metadata.terminalconfig.buffer.length-BW.metadata.terminalconfig.pos-1)}$(BW.elements["console_left_command"]).text(a);$(BW.elements["console_cursor"]).text(b);if(b==" "){$(BW.elements["console_cursor"]).html(" ")}$(BW.elements["console_right_command"]).text(c);$(BW.elements["console_prompt"]).text(BW.text.username);return},clearInputBuffer:function(){BW.metadata.terminalconfig.buffer="";BW.metadata.terminalconfig.pos=0;BW.terminal.updateInputDisplay()},clear:function(){$(BW.elements["display"]).html("")},addCharacter:function(a){var b=BW.metadata.terminalconfig.buffer.substr(0,BW.metadata.terminalconfig.pos);var c=BW.metadata.terminalconfig.buffer.substr(BW.metadata.terminalconfig.pos,BW.metadata.terminalconfig.buffer.length-BW.metadata.terminalconfig.pos);BW.metadata.terminalconfig.buffer=b+a+c;BW.metadata.terminalconfig.pos++;BW.terminal.updateInputDisplay();BW.terminal.setCursorState(true)},deleteCharacter:function(a){var b=a?1:0;if(BW.metadata.terminalconfig.pos>=1-b){var c=BW.metadata.terminalconfig.buffer.substr(0,BW.metadata.terminalconfig.pos-1+b);var d=BW.metadata.terminalconfig.buffer.substr(BW.metadata.terminalconfig.pos+b,BW.metadata.terminalconfig.buffer.length-BW.metadata.terminalconfig.pos-b);BW.metadata.terminalconfig.buffer=c+d;BW.metadata.terminalconfig.pos-=1-b;BW.terminal.updateInputDisplay()}BW.terminal.setCursorState(true)},deleteWord:function(){if(BW.metadata.terminalconfig.pos>0){var a=BW.metadata.terminalconfig.pos;while(a>0&&BW.metadata.terminalconfig.buffer.charAt(a)!==" "){a--}left=BW.metadata.terminalconfig.buffer.substr(0,a-1);right=BW.metadata.terminalconfig.buffer.substr(a,BW.metadata.terminalconfig.buffer.length-BW.metadata.terminalconfig.pos);BW.metadata.terminalconfig.buffer=left+right;BW.metadata.terminalconfig.pos=a;BW.terminal.updateInputDisplay()}BW.terminal.setCursorState(true)},moveCursor:function(a){BW.terminal.setPos(BW.metadata.terminalconfig.pos+a)},setPos:function(a){if(a>=0&&a<=BW.metadata.terminalconfig.buffer.length){BW.metadata.terminalconfig.pos=a;BW.terminal.updateInputDisplay()}BW.terminal.setCursorState(true)},moveHistory:function(a){var b=BW.metadata.terminalconfig.historyPos+a;if(b>=0&&b<=BW.metadata.terminalconfig.history.length){if(b==BW.metadata.terminalconfig.history.length){BW.terminal.clearInputBuffer()}else{BW.metadata.terminalconfig.buffer=BW.metadata.terminalconfig.history[b]}BW.metadata.terminalconfig.pos=BW.metadata.terminalconfig.buffer.length;BW.metadata.terminalconfig.historyPos=b;BW.terminal.updateInputDisplay();BW.terminal.jumpToBottom()}BW.terminal.setCursorState(true)},addHistory:function(a){BW.metadata.terminalconfig.historyPos=BW.metadata.terminalconfig.history.push(a)},jumpToBottom:function(){$(BW.elements["console_screen"]).animate({scrollTop:$(BW.elements["console_screen"]).height()},BW.metadata.config.scrollSpeed,"linear")},jumpToTop:function(){$(BW.elements["console_screen"]).animate({scrollTop:0},BW.metadata.config.scrollSpeed,"linear")},scrollPage:function(a){$(BW.elements["console_screen"]).animate({scrollTop:$(BW.elements["console_screen"]).scrollTop()+a*$(BW.elements["console_screen"]).height()*.75},BW.metadata.config.scrollSpeed,"linear")},scrollLine:function(a){$(BW.elements["console_screen"]).scrollTop($(BW.elements["console_screen"]).scrollTop()+a*BW.metadata.config.scrollStep)},print:function(a){if(!a){$(BW.elements["display"]).append($("<div>"))}else if(a instanceof jQuery){$(BW.elements["display"]).append(a)}else{var b=Array.prototype.slice.call(arguments,0);$(BW.elements["display"]).append($("<p>").text(b.join(" ")))}BW.terminal.jumpToBottom();return $(BW.elements["display"]).find("p:last-child")},processInputBuffer:function(a){BW.terminal.print($("<p>").addClass("command").text(BW.text.username+BW.metadata.terminalconfig.buffer));var a=$.trim(BW.metadata.terminalconfig.buffer);BW.terminal.clearInputBuffer();if(a.length==0){return false}BW.terminal.addHistory(a);return BW.terminal.process(BW,a)},setPromptActive:function(a){BW.metadata.terminalconfig.promptActive=a;$(BW.elements["console_entry"]).toggle(BW.metadata.terminalconfig.promptActive)},setWorking:function(a){if(a&&!BW.metadata.terminalconfig._spinnerTimeout){$(BW.elements["display"]+" "+BW.elements["command"]+":last-child").add(BW.elements["bottom_line"]).first().append($(BW.elements["console_loading"]));BW.metadata.terminalconfig._spinnerTimeout=window.setInterval($.proxy(function(){if(!$(BW.elements["console_loading"]).is(":visible")){$(BW.elements["console_loading"]).fadeIn()}BW.metadata.terminalconfig.spinnerIndex=(BW.metadata.terminalconfig.spinnerIndex+1)%BW.metadata.config.spinnerCharacters.length;$(BW.elements["console_loading"]).text(BW.metadata.config.spinnerCharacters[BW.metadata.terminalconfig.spinnerIndex])},BW),BW.metadata.config.spinnerSpeed);BW.terminal.setPromptActive(false);$(BW.elements["console_screen"]).triggerHandler("cli-busy")}else if(!a&&BW._spinnerTimeout){clearInterval(BW.metadata.terminalconfig._spinnerTimeout);BW.metadata.terminalconfig._spinnerTimeout=null;$(BW.elements["console_loading"]).fadeOut();BW.terminal.setPromptActive(true);$(BW.elements["console_screen"]).triggerHandler("cli-ready")}},runCommand:function(a){var b=0,c=false;BW.metadata.terminalconfig.promptActive=false;var d=window.setInterval($.proxy(function e(){if(b<a.length){BW.terminal.addCharacter(a.charAt(b));b+=1}else{clearInterval(d);BW.metadata.terminalconfig.promptActive=true;BW.terminal.processInputBuffer()}},BW),BW.metadata.config.typingSpeed)},runText:function(a,b){var c=0,d;var e=Math.round(Math.random()*1e4);tag="<"+b+">";var d=b+"#"+e;BW.metadata.terminalconfig.promptActive=false;BW.terminal.print($(tag).attr("id",e).text(a.substr(0,1)));c=1;var f=window.setInterval($.proxy(function g(){if(c<a.length){$(d).append(a.charAt(c));c+=1}else{clearInterval(f);$(d).removeAttr("id");BW.metadata.terminalconfig.promptActive=true}},BW),BW.metadata.config.typingSpeed/(1+a.length*.01))},run:function(){$(document).keypress($.proxy(BW.terminal.isActive(function(a){if(a.which>=32&&a.which<=126){var b=String.fromCharCode(a.which);var c=b.toLowerCase()}else{return}if($.browser.opera&&!/[\w\s]/.test(b)){return}if(BW.functions.sticky.keys.ctrl){if(c=="w"){BW.terminal.deleteWord()}else if(c=="h"){BW.terminal.deleteCharacter(false)}else if(c=="l"){BW.terminal.clear()}else if(c=="a"){BW.terminal.setPos(0)}else if(c=="e"){BW.terminal.setPos(BW.buffer.length)}else if(c=="d"){BW.terminal.runCommand("logout")}}else{if(b){BW.terminal.addCharacter(b);a.preventDefault()}}}),BW)).bind("keydown","return",BW.terminal.isActive(function(a){BW.terminal.processInputBuffer()})).bind("keydown","backspace",BW.terminal.isActive(function(a){a.preventDefault();BW.terminal.deleteCharacter(a.shiftKey)})).bind("keydown","del",BW.terminal.isActive(function(a){BW.terminal.deleteCharacter(true)})).bind("keydown","left",BW.terminal.isActive(function(a){BW.terminal.moveCursor(-1)})).bind("keydown","right",BW.terminal.isActive(function(a){BW.terminal.moveCursor(1)})).bind("keydown","up",BW.terminal.isActive(function(a){a.preventDefault();if(a.shiftKey||BW.functions.sticky.keys.scroll){BW.terminal.scrollLine(-1)}else if(a.ctrlKey||BW.functions.sticky.keys.ctrl){BW.terminal.scrollPage(-1)}else{BW.terminal.moveHistory(-1)}})).bind("keydown","down",BW.terminal.isActive(function(a){a.preventDefault();if(a.shiftKey||BW.functions.sticky.keys.scroll){BW.terminal.scrollLine(1)}else if(a.ctrlKey||BW.functions.sticky.keys.ctrl){BW.terminal.scrollPage(1)}else{BW.terminal.moveHistory(1)}})).bind("keydown","pageup",BW.terminal.isActive(function(a){BW.terminal.scrollPage(-1)})).bind("keydown","pagedown",BW.terminal.isActive(function(a){BW.terminal.scrollPage(1)})).bind("keydown","home",BW.terminal.isActive(function(a){a.preventDefault();if(a.ctrlKey||BW.functions.sticky.keys.ctrl){BW.terminal.jumpToTop()}else{BW.terminal.setPos(0)}})).bind("keydown","end",BW.terminal.isActive(function(a){a.preventDefault();if(a.ctrlKey||BW.functions.sticky.keys.ctrl){BW.terminal.jumpToBottom()}else{BW.terminal.setPos(BW.metadata.terminalconfig.buffer.length)}})).bind("keydown","tab",function(a){a.preventDefault()}).keyup(function(a){var b=$.hotkeys.specialKeys[a.which];if(b in{ctrl:true,alt:true,scroll:true}){BW.functions.sticky.toggle(b)}else if(!(b in{left:true,right:true,up:true,down:true})){BW.functions.sticky.resetAll()}});$(window).resize(function(a){$(BW.elements["console_screen"]).scrollTop($(BW.elements["console_screen"]).height())});BW.terminal.setCursorState(true);BW.terminal.setWorking(false);$(BW.elements["console_prompt"]).html(BW.text.username);$(BW.elements["console_screen"]).hide().fadeIn("fast",function(){$(BW.elements["console_screen"]).triggerHandler("cli-load")})}}}